import { DependenciesParser } from "../src/dependenciesParser";
import { INode } from "../src/interfaces";
import { TestConsole } from "./testConsole";

const testConsole = new TestConsole();
const scan = new DependenciesParser(testConsole);
var treeList = scan.parse("tests/data/dependencies.txt");

describe(`Dependencies parse`, () => {
  test("no errors", () => {
    expect(testConsole.errorLines).toHaveLength(0);
  });

  test("simple dependency", () => {
    expect(treeList).toHaveLength(174);
    const firstOne = treeList[0];
    expect(firstOne.level).toBe(1);
    expect(firstOne.library).toBe("com.puppycrawl.tools:checkstyle");
    expect(firstOne.version).toBe("8.45.1");
    expect(firstOne.childNodes).toHaveLength(7);
    expect(firstOne.childNodes[4].childNodes[1].level).toBe(3);
    expect(firstOne.childNodes[4].childNodes[1].version).toBe("9999.0-empty-to-avoid-conflict-with-guava");
  });

  test("detect correct version", () => {
    const firstOne = treeList[1].childNodes[0].childNodes[3];
    expect(firstOne.library).toBe("com.fasterxml.jackson.datatype:jackson-datatype-jdk8");
    expect(firstOne.version).toBe("2.13.5");
  });

  test("project dependency", () => {
    const last1 = last(treeList);
    const last2 = last(last1.childNodes);
    expect(last2.level).toBe(2);
    expect(last2.library).toBe("project :uu_energygateway_datagatewayg01-machine-user (*)");
  });
});

function last(arr: INode[]): INode {
  return arr[arr.length - 1];
}
